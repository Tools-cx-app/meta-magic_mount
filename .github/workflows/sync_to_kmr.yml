name: Sync Release to KernelSU Modules Repository

permissions:
  contents: read

env:
  TARGET_REPO: 'KernelSU-Modules-Repo/magic_mount_rs'

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Release Tag (For Manual Sync)'
        required: true

jobs:
    sync:
        # Avoid affecting the fork
        if: github.repository == 'Tools-cx-app/meta-magic_mount'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                fetch-depth: 0

            - name: Fetch Release
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              id: fetch_release
              run: |
                set -euo pipefail
                TARGET_TAG="${{ github.event.inputs.tag_name || github.event.release.tag_name }}"
                echo "Target Tag to sync: $TARGET_TAG"
                mkdir -p sync-assets
                gh release download "$TARGET_TAG" --pattern "*.zip" --dir sync-assets/ --skip-existing
                if [ -z "$(ls -A sync-assets/)" ]; then
                    echo "Error: No assets downloaded. Check if the tag is correct and has files."
                    exit 1
                fi
                REL_JSON=$(gh release view "$TARGET_TAG" --json body,name)
                REL_NAME=$(echo "$REL_JSON" | jq -r '.name')
                echo "$REL_JSON" | jq -r '.body' > /tmp/changelog.md
                echo "tag_name=$TARGET_TAG" >> $GITHUB_OUTPUT
                echo "rel_name=$REL_NAME" >> $GITHUB_OUTPUT

            - name: Upload to KernelSU Modules Repo (via GH CLI)
              env:
                # Required token:
                # - KERNELSU_MODULES_REPO_PUBLISH_TOKEN
                # - Must have permission to create releases in the target repository
                # - Fine-grained or classic PAT can be used depending on repository support
                #   * Classic PAT: `repo` scope
                #   * Fine-grained PAT: `contents: write` permission
                # - If Fine-grained PAT is not supported, a dedicated bot account with a classic PAT can be used
                GH_TOKEN: ${{ secrets.KERNELSU_MODULES_REPO_PUBLISH_TOKEN }}
                TAG_NAME: ${{ steps.fetch_release.outputs.tag_name }}
                REL_NAME: ${{ steps.fetch_release.outputs.rel_name }}
              run: |
                gh release create "$TAG_NAME" \
                  --repo "$TARGET_REPO" \
                  --title "$REL_NAME" \
                  --notes-file /tmp/changelog.md \
                  --draft=false \
                  --prerelease=false \
                  sync-assets/*